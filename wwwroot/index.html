<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrum Poker Real-Time</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <style>
        :root {
            --primary: #007bff;
            --success: #28a745;
            --bg: #f0f2f5;
            --white: #ffffff;
            --text: #333;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            display: flex;
            justify-content: center;
            padding: 20px;
            color: var(--text);
        }

        .container {
            background: var(--white);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 650px;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .card {
            border: 2px solid #ddd;
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            font-weight: bold;
            background: white;
        }

            .card:hover {
                border-color: var(--primary);
                transform: translateY(-2px);
            }

            .card.selected {
                background: var(--primary) !important;
                color: white !important;
                border-color: var(--primary) !important;
            }

        .player-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
            background: #fff;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .avatar-small {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 1px solid #ddd;
            object-fit: cover;
        }

        .admin-controls {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #ffeeba;
        }

        .share-box {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 0.9em;
            word-break: break-all;
        }

        .history-section, .task-list-section, .players-section {
            margin-top: 30px;
            border-top: 2px solid #eee;
            padding-top: 20px;
        }

        .history-item, .task-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .avg-badge {
            background: #6f42c1;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        input, textarea, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        button {
            cursor: pointer;
            background: var(--primary);
            color: white;
            border: none;
            font-weight: bold;
        }

            button.secondary {
                background: #6c757d;
            }

        .admin-btn-group {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

            .admin-btn-group button {
                margin: 0;
                flex: 1;
            }

        .icon-btn {
            width: auto;
            padding: 8px 12px;
            margin: 0 2px;
            font-size: 0.9em;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-warning {
            background: var(--warning);
            color: #212529;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .badge {
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .avatar-selection {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }

        .avatar-choice {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: 0.2s;
            object-fit: cover;
        }

            .avatar-choice.selected {
                border-color: var(--primary);
                background: #e7f3ff;
            }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            pointer-events: none;
        }

        .toast {
            background: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transform: translateX(20px);
            transition: 0.3s all;
            pointer-events: auto;
        }

            .toast.show {
                opacity: 1;
                transform: translateX(0);
            }

        .waiting-msg {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
            background: #fdfdfe;
            border: 1px dashed #ccc;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .avg-display {
            text-align: center;
            margin: 15px 0;
            padding: 10px;
            background: #f0f7ff;
            border-radius: 8px;
            border: 1px solid #cce5ff;
        }
    </style>
</head>
<body>
    <div id="toastContainer" class="toast-container"></div>
    <div class="container">
        <div id="loginArea">
            <h2 style="text-align:center">Scrum Poker</h2>
            <div class="entry-buttons">
                <button onclick="toggleModal('createRoomModal', true)"><i class="fas fa-plus-circle"></i> Oda Oluştur</button>
                <button class="secondary" onclick="toggleModal('joinRoomModal', true)"><i class="fas fa-sign-in-alt"></i> Odaya Katıl</button>
            </div>
        </div>

        <div id="gameArea" style="display:none">
            <div class="task-counter" id="taskCounterDisplay">Task: 0 / 0</div>
            <div id="shareArea" class="share-box"><strong>Paylaşım Linki:</strong> <br><span id="shareLink"></span></div>
            <div class="players-section"><strong><i class="fas fa-users"></i> Katılımcılar</strong><div id="playersList" style="margin-top:10px"></div></div>
            <div id="waitingArea" class="waiting-msg" style="display:none"><i class="fas fa-spinner fa-spin"></i> Admin'in seansı başlatması bekleniyor...</div>
            <div id="votingArea" style="display:none; margin-top: 20px; border-top: 2px solid #eee; padding-top: 20px;">
                <h2 id="currentTaskTitle">Task Yükleniyor...</h2>
                <div id="averageDisplayArea"></div>
                <div id="voteInputContainer"></div>
            </div>
            <div id="adminPanel" class="admin-controls" style="display:none">
                <strong>Yönetici Paneli</strong>
                <div id="startBtnArea"><button class="btn-success" onclick="invokeServer('StartRoom')"><i class="fas fa-play"></i> Seansı Başlat</button></div>
                <div id="activeAdminControls" style="display:none">
                    <div class="admin-option"><input type="checkbox" id="peekVotesCheckbox" onchange="onPeekChange()"><label for="peekVotesCheckbox">Seçimleri anlık gör</label></div>
                    <div class="admin-btn-group">
                        <button onclick="invokeServer('ShowVotes')"><i class="fas fa-eye"></i> Show</button>
                        <button class="secondary" onclick="safeNextTask()"><i class="fas fa-step-forward"></i> Next</button>
                        <button style="background:#17a2b8" onclick="toggleModal('addTaskModal', true)"><i class="fas fa-plus"></i> Add</button>
                    </div>
                </div>
                <div id="preStartAdminControls"><button style="background:#17a2b8; margin-top:10px;" onclick="toggleModal('addTaskModal', true)"><i class="fas fa-plus"></i> Yeni Task Ekle</button></div>
                <div class="task-list-section"><strong><i class="fas fa-list"></i> Tüm Tasklar</strong><div id="adminTaskList"></div></div>
            </div>
            <div class="history-section"><h3><i class="fas fa-history"></i> Oylama Geçmişi</h3><div id="historyList"></div></div>
        </div>
    </div>

    <div id="createRoomModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3>Yeni Oda Oluştur</h3><span class="modal-close" onclick="toggleModal('createRoomModal', false)">&times;</span></div>
            <input type="text" id="adminName" placeholder="Adınız">
            <div class="avatar-selection" id="adminAvatars"></div>
            <input type="text" id="roomName" placeholder="Oda Adı">
            <div class="admin-option"><input type="checkbox" id="freeTextCheck" onchange="document.getElementById('optArea').style.display = this.checked ? 'none' : 'block'"><label for="freeTextCheck">Free Text Oylama</label></div>
            <div id="optArea"><input type="text" id="estimateOptions" value="0.5, 1, 2, 3, 5, 8, 13, 21, ?, ☕"></div>
            <button onclick="startSession(true)">Odayı Başlat</button>
        </div>
    </div>

    <div id="joinRoomModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3>Odaya Katıl</h3><span class="modal-close" onclick="toggleModal('joinRoomModal', false)">&times;</span></div>
            <input type="text" id="participantName" placeholder="Adınız">
            <div class="avatar-selection" id="joinAvatars"></div>
            <input type="text" id="roomIdInput" placeholder="Oda ID">
            <button onclick="startSession(false)">Giriş Yap</button>
        </div>
    </div>

    <div id="addTaskModal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h3>Ekle</h3><span class="modal-close" onclick="toggleModal('addTaskModal', false)">&times;</span></div><input type="text" id="instantTask"><button onclick="addInstantTask()">Ekle</button></div></div>
    <div id="editTaskModal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h3>Düzenle</h3><span class="modal-close" onclick="toggleModal('editTaskModal', false)">&times;</span></div><input type="hidden" id="editTaskId"><input type="text" id="editTaskTitle"><button onclick="updateTask()">Güncelle</button></div></div>
    <div id="confirmModal" class="modal-overlay"><div class="modal-content"><h3 id="confirmTitle"></h3><p id="confirmMessage"></p><button class="btn-danger" onclick="closeConfirm(true)">Evet</button><button class="secondary" onclick="closeConfirm(false)">Hayır</button></div></div>

    <script>
        const connection = new signalR.HubConnectionBuilder().withUrl("/pokerHub").withAutomaticReconnect().build();
        let activeRoomId = "", lastRoomState = null, confirmCallback = null, selectedAvatar = "";
        const avatarlar = ["/images/avatar1.png", "/images/avatar2.png", "/images/avatar3.png", "/images/avatar4.png", "/images/avatar5.png"];

        window.onload = () => {
            initAvatarSelection('adminAvatars'); initAvatarSelection('joinAvatars');
            const rId = new URLSearchParams(window.location.search).get('room');
            if (rId) { document.getElementById("roomIdInput").value = rId; document.getElementById("roomIdInput").disabled = true; toggleModal('joinRoomModal', true); }
        };

        function initAvatarSelection(id) {
            const c = document.getElementById(id);
            c.innerHTML = avatarlar.map(url => `<img src="${url}" class="avatar-choice" onclick="selectAvatar(this, '${url}')" onerror="this.src='https://api.dicebear.com/7.x/avataaars/svg?seed=fallback'">`).join('');
            selectAvatar(c.querySelector('img'), avatarlar[0]);
        }

        function selectAvatar(el, url) { el.parentElement.querySelectorAll('.avatar-choice').forEach(i => i.classList.remove('selected')); el.classList.add('selected'); selectedAvatar = url; }
        function showToast(m, t = 'info') {
            const c = document.getElementById('toastContainer');
            const d = document.createElement('div'); d.className = `toast toast-${t}`; d.innerHTML = `<span>${m}</span>`;
            c.appendChild(d); setTimeout(() => d.classList.add('show'), 100);
            setTimeout(() => { d.classList.remove('show'); setTimeout(() => d.remove(), 300); }, 4000);
        }

        connection.on("PeekStatusChanged", (p) => { showToast(p ? "Admin oyları anlık izliyor!" : "Anlık izleme kapandı."); refreshCurrentRoomUI(); });
        async function onPeekChange() { await connection.invoke("TogglePeekStatus", activeRoomId, document.getElementById("peekVotesCheckbox").checked); }

        function toggleModal(id, show, data = null) {
            const m = document.getElementById(id); m.style.display = show ? "flex" : "none";
            if (!show) m.querySelectorAll('input[type="text"]:not(#estimateOptions)').forEach(i => { if (!i.disabled) i.value = "" });
            else if (id === 'editTaskModal' && data) { document.getElementById("editTaskId").value = data.id; document.getElementById("editTaskTitle").value = data.title; }
        }

        function openConfirm(t, m, c) { document.getElementById("confirmTitle").innerText = t; document.getElementById("confirmMessage").innerText = m; confirmCallback = c; document.getElementById("confirmModal").style.display = "flex"; }
        function closeConfirm(r) { document.getElementById("confirmModal").style.display = "none"; if (r && confirmCallback) confirmCallback(); confirmCallback = null; }

        async function startSession(isAdmin) {
            const user = document.getElementById(isAdmin ? "adminName" : "participantName").value;
            if (!user) return alert("Adınızı girin");
            try {
                if (connection.state === "Disconnected") await connection.start();
                if (isAdmin) {
                    const rN = document.getElementById("roomName").value, opts = document.getElementById("estimateOptions").value.split(',').map(x => x.trim()).filter(x => x), fT = document.getElementById("freeTextCheck").checked;
                    activeRoomId = await connection.invoke("CreateRoom", rN, user, selectedAvatar, [], opts, fT);
                    document.getElementById("shareLink").innerText = window.location.origin + window.location.pathname + "?room=" + activeRoomId;
                    toggleModal('createRoomModal', false);
                } else {
                    activeRoomId = document.getElementById("roomIdInput").value;
                    toggleModal('joinRoomModal', false);
                }
                await connection.invoke("JoinRoom", activeRoomId, user, selectedAvatar);
                document.getElementById("loginArea").style.display = "none"; document.getElementById("gameArea").style.display = "block";
            } catch (err) { alert(err.message); }
        }

        connection.on("NewTaskTriggered", () => { document.querySelectorAll('.poker-card').forEach(c => c.classList.remove('selected')); document.getElementById("voteInputContainer").innerHTML = ""; });
        function refreshCurrentRoomUI() { if (lastRoomState) renderRoom(lastRoomState); }
        connection.on("RoomUpdated", (room) => { if (room.roomId !== activeRoomId) return; lastRoomState = room; renderRoom(room); });

        function renderRoom(room) {
            const isAdmin = connection.connectionId === room.adminConnectionId;
            const peekEnabled = document.getElementById("peekVotesCheckbox")?.checked || false;

            if (isAdmin) {
                document.getElementById("adminPanel").style.display = "block";
                document.getElementById("startBtnArea").style.display = room.isStarted ? "none" : "block";
                document.getElementById("activeAdminControls").style.display = room.isStarted ? "block" : "none";
                document.getElementById("preStartAdminControls").style.display = room.isStarted ? "none" : "block";
                document.getElementById("adminTaskList").innerHTML = room.tasks.map((t, i) => {
                    const canED = i >= room.currentTaskIndex && !(i === room.currentTaskIndex && room.isVotesRevealed);
                    return `<div class="task-item"><span>${i + 1}. ${t.title} ${i === room.currentTaskIndex && room.isStarted ? '<span class="badge">Aktif</span>' : ''}</span>
                        <div>${canED ? `<button class="icon-btn btn-warning" onclick="toggleModal('editTaskModal', true, {id:'${t.id}', title:'${t.title}'})"><i class="fas fa-edit"></i></button>
                        <button class="icon-btn btn-danger" onclick="safeDeleteTask('${t.id}')"><i class="fas fa-trash-alt"></i></button>` : ''}</div></div>`;
                }).join('');
            }

            document.getElementById("waitingArea").style.display = room.isStarted ? "none" : (isAdmin ? "none" : "block");
            document.getElementById("votingArea").style.display = room.isStarted ? "block" : "none";

            // Ortalama Hesaplama ve Gösterim
            const avgArea = document.getElementById("averageDisplayArea");
            if (room.isVotesRevealed && !room.isFreeText) {
                const vals = room.players.map(p => parseFloat(p.vote)).filter(v => !isNaN(v));
                if (vals.length > 0) {
                    const avg = (vals.reduce((a, b) => a + b, 0) / vals.length).toFixed(1);
                    avgArea.innerHTML = `<div class="avg-display"><strong><i class="fas fa-chart-bar"></i> Ortalama Tahmin: ${avg}</strong></div>`;
                } else avgArea.innerHTML = "";
            } else avgArea.innerHTML = "";

            const total = room.tasks.length, current = total > 0 ? Math.min(room.currentTaskIndex + 1, total) : 0;
            document.getElementById("taskCounterDisplay").innerText = `Task: ${current} / ${total}`;
            document.getElementById("currentTaskTitle").innerText = room.activeTask ? room.activeTask.title : (total > 0 && room.isStarted ? "Oylama Bitti" : "Task Bekleniyor...");

            const container = document.getElementById("voteInputContainer");
            if (room.isVotesRevealed || !room.activeTask) container.innerHTML = "";
            else if (container.innerHTML === "") {
                if (room.isFreeText) container.innerHTML = `<div class="free-text-vote-area"><input type="text" id="freeTextInput" placeholder="Efor..."><button onclick="sendFreeTextVote()">Gönder</button></div>`;
                else container.innerHTML = `<div class="card-grid">${room.estimateOptions.map(opt => `<div class="card poker-card" onclick="vote(this, '${opt}')">${opt}</div>`).join('')}</div>`;
            }

            document.getElementById("playersList").innerHTML = room.players.map(p => {
                let d = "⏳";
                if (room.isVotesRevealed) d = p.vote || '-';
                else if (p.hasVoted) d = (isAdmin && peekEnabled) ? `👁️ ${p.vote}` : "✅";
                if (!room.isStarted) d = "";
                return `<div class="player-row"><div class="player-info"><img src="${p.avatarUrl}" class="avatar-small"><span>${p.name} ${p.connectionId === room.adminConnectionId ? '<span class="badge">Admin</span>' : ''}</span></div><strong>${d}</strong></div>`;
            }).join('');

            document.getElementById("historyList").innerHTML = room.history.map(h => `
                    <div class="history-item">
                        <div>
                            <strong>${h.title}</strong>
                            ${h.average ? `<span class="avg-badge" title="Ortalama Puan"><i class="fas fa-calculator"></i> ${h.average}</span>` : ''}
                            <div class="history-votes">${h.results.map(r => `${r.name}: ${r.vote || '-'}`).join(' | ')}</div>
                        </div>
                    </div>`).reverse().join('');
        }

        async function vote(el, val) {
            if (!lastRoomState?.isStarted || !lastRoomState?.activeTask) return;
            document.querySelectorAll('.poker-card').forEach(c => c.classList.remove('selected'));
            if (el) el.classList.add('selected');
            await connection.invoke("SendVote", activeRoomId, val);
        }
        async function sendFreeTextVote() { const v = document.getElementById("freeTextInput").value; if (!v) return alert("Değer girin!"); await vote(null, v); }
        async function invokeServer(m) { await connection.invoke(m, activeRoomId); }
        async function safeNextTask() {
            if (!lastRoomState) return;
            const anyV = lastRoomState.players.some(p => p.hasVoted);
            if (!anyV) openConfirm("Uyarı", "Kimse oy vermedi. Geçilsin mi?", async () => await invokeServer('NextTask'));
            else if (!lastRoomState.isVotesRevealed) openConfirm("Dikkat", "Sonuçları paylaşmadınız. Geçilsin mi?", async () => await invokeServer('NextTask'));
            else await invokeServer('NextTask');
        }
        async function safeDeleteTask(id) { openConfirm("Silme Onayı", "Silinsin mi?", async () => await connection.invoke("DeleteTask", activeRoomId, id)); }
        async function addInstantTask() { const t = document.getElementById("instantTask").value; if (t) { await connection.invoke("AddTasks", activeRoomId, [t]); toggleModal('addTaskModal', false); } }
        async function updateTask() { const id = document.getElementById("editTaskId").value; const t = document.getElementById("editTaskTitle").value; if (t) { await connection.invoke("UpdateTask", activeRoomId, id, t); toggleModal('editTaskModal', false); } }
    </script>
</body>
</html>